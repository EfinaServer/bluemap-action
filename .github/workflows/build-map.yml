name: Build Online Map

on:
  workflow_call:
    inputs:
      runs-on-cache-hit:
        description: "Runner when cache exists (smaller machine for incremental render)"
        required: false
        type: string
        default: "blacksmith-2vcpu-ubuntu-2404"
      runs-on-cache-miss:
        description: "Runner when no cache (larger machine for full render)"
        required: false
        type: string
        default: "blacksmith-8vcpu-ubuntu-2404"
      server-directory:
        description: "Server directory containing config.toml (e.g. onlinemap-01)"
        required: true
        type: string
      bluemap-action-version:
        description: "bluemap-action release tag to use (e.g. v1.0.0). Defaults to latest."
        required: false
        type: string
        default: "latest"
      java-version:
        description: "Java version for BlueMap CLI rendering"
        required: false
        type: string
        default: "21"
      deploy-to-netlify:
        description: "Whether to deploy the rendered output to Netlify"
        required: false
        type: boolean
        default: true
      netlify-site-id:
        description: "Netlify site ID for deployment (required if deploy-to-netlify is true)"
        required: false
        type: string
    secrets:
      PTERODACTYL_PANEL_URL:
        description: "Pterodactyl panel base URL"
        required: true
      PTERODACTYL_API_KEY:
        description: "Pterodactyl client API key"
        required: true
      NETLIFY_AUTH_TOKEN:
        description: "Netlify authentication token (required if deploy-to-netlify is true)"
        required: false

jobs:
  check-cache:
    runs-on: ${{ inputs.runs-on-cache-hit }}
    outputs:
      runner: ${{ steps.select-runner.outputs.runner }}
    steps:
      - name: Check web/maps cache
        id: cache-check
        uses: actions/cache/restore@v5
        with:
          path: ${{ inputs.server-directory }}/web/maps
          key: bluemap-maps-${{ inputs.server-directory }}-
          restore-keys: |
            bluemap-maps-${{ inputs.server-directory }}-
          lookup-only: true

      - name: Select runner
        id: select-runner
        run: |
          if [ -n "${{ steps.cache-check.outputs.cache-matched-key }}" ]; then
            echo "Cache found (key: ${{ steps.cache-check.outputs.cache-matched-key }}) — using smaller runner"
            echo "runner=${{ inputs.runs-on-cache-hit }}" >> "$GITHUB_OUTPUT"
          else
            echo "No cache — using larger runner"
            echo "runner=${{ inputs.runs-on-cache-miss }}" >> "$GITHUB_OUTPUT"
          fi

  build-map:
    needs: check-cache
    runs-on: ${{ needs.check-cache.outputs.runner }}
    steps:
      - name: Checkout caller repository
        uses: actions/checkout@v6

      - name: Set up Java
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: ${{ inputs.java-version }}

      - name: Download bluemap-action
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ "${{ inputs.bluemap-action-version }}" = "latest" ]; then
            echo "Downloading latest release..."
            gh release download --repo EfinaServer/bluemap-action \
              --pattern "bluemap-action-linux-amd64" \
              --dir /usr/local/bin
          else
            echo "Downloading ${{ inputs.bluemap-action-version }}..."
            gh release download "${{ inputs.bluemap-action-version }}" \
              --repo EfinaServer/bluemap-action \
              --pattern "bluemap-action-linux-amd64" \
              --dir /usr/local/bin
          fi
          chmod +x /usr/local/bin/bluemap-action-linux-amd64
          mv /usr/local/bin/bluemap-action-linux-amd64 /usr/local/bin/bluemap-action

      - name: Restore web/maps cache
        uses: actions/cache@v5
        with:
          path: ${{ inputs.server-directory }}/web/maps
          key: bluemap-maps-${{ inputs.server-directory }}-${{ github.run_id }}
          restore-keys: |
            bluemap-maps-${{ inputs.server-directory }}-

      - name: Build map
        env:
          PTERODACTYL_PANEL_URL: ${{ secrets.PTERODACTYL_PANEL_URL }}
          PTERODACTYL_API_KEY: ${{ secrets.PTERODACTYL_API_KEY }}
        run: bluemap-action -dir "${{ inputs.server-directory }}"

      - name: Deploy to Netlify
        if: inputs.deploy-to-netlify
        working-directory: ${{ inputs.server-directory }}/web
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ inputs.netlify-site-id }}
        run: >-
          npx netlify-cli deploy
          --prod
          --no-build
          --dir '.'
          --message "Deploy from GitHub Actions at $(TZ='Asia/Taipei' date +'%Y-%m-%d %H:%M:%S %Z')"
